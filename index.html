<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ØªØ¹Ù„Ù… Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø£Ø±Ø¯ÙˆÙŠÙ†Ùˆ â€” Ù†Ø³Ø®Ø© Ù…ÙˆØ³Ù‘Ø¹Ø©</title>
  <meta name="theme-color" content="#0aa2b8" />
  <style>
    :root {
      --bg1: #121423; --bg2: #1a1d2f;
      --glass: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.18);
      --accent: #0aa2b8; --accent-2: #4caf50; --danger: #b00020; --warn: #ff9800;
      --text: #e9f1f7; --muted: #a9b7c6;
      --code-bg: #0e1217; --code-txt: #b5f5ff;
    }
    [data-theme="light"] {
      --bg1: #eef3f7; --bg2: #ffffff;
      --glass: rgba(255,255,255,0.75);
      --border: rgba(0,0,0,0.12);
      --text: #0f1b28; --muted: #425364;
      --code-bg: #f8fafc; --code-txt: #0f1b28;
    }
    * { box-sizing: border-box }
    body {
      margin: 0; color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", "Cairo", sans-serif;
      background:
        radial-gradient(1000px 500px at 10% 10%, #0e6788 0%, transparent 55%),
        radial-gradient(900px 450px at 90% 90%, #5a2a8a 0%, transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height: 100dvh;
    }
    header {
      position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(12px);
      background: var(--glass);
      border-bottom: 1px solid var(--border);
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 18px }
    .brand { display: flex; align-items: center; gap: 12px }
    .logo {
      width: 42px; height: 42px; border-radius: 12px;
      background: linear-gradient(180deg,#12c2e9,#0aa2b8);
      display: grid; place-items: center; color: #032a33; font-weight: 900;
      box-shadow: 0 8px 24px rgba(18,194,233,0.25);
    }
    h1 { margin: 0; font-size: 1.35rem }
    nav { margin-top: 8px; display: flex; gap: 10px; flex-wrap: wrap }
    .nav-link {
      color: var(--text); text-decoration: none;
      padding: 8px 12px; border-radius: 999px;
      border: 1px solid var(--border); background: rgba(255,255,255,0.06);
      font-size: .9rem;
    }
    .nav-link.active { background: var(--accent); border-color: transparent; color: white }
    main { padding: 18px 0 }
    .grid { display: grid; gap: 18px; grid-template-columns: 1fr }
    @media (min-width: 980px) { .grid { grid-template-columns: 2fr 1fr } }
    section.card {
      background: var(--glass); backdrop-filter: blur(16px);
      border: 1px solid var(--border); border-radius: 18px; padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    section.card h2 { margin: 0 0 12px 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px }
    p { color: var(--muted); line-height: 1.7 }
    video, .media { width: 100%; border-radius: 14px; overflow: hidden; border: 1px solid var(--border) }
    .lessons-grid { display: grid; gap: 14px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .lessons-grid { grid-template-columns: 1fr 1fr } }
    @media (min-width: 1024px) { .lessons-grid { grid-template-columns: 1fr 1fr 1fr } }
    .lesson-card {
      background: rgba(255,255,255,0.07); border: 1px solid var(--border); border-radius: 14px;
      padding: 14px; display: flex; flex-direction: column; gap: 8px;
    }
    .lesson-card h3 { margin: 0; font-size: 1.05rem }
    .lesson-card .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap }
    .pill {
      display: inline-block; padding: 6px 10px; border-radius: 999px;
      background: rgba(255,255,255,0.08); border: 1px solid var(--border);
      color: var(--muted); font-size: .85rem
    }
    .code { background: var(--code-bg); color: var(--code-txt); border-radius: 12px; padding: 12px; border: 1px solid #18202b; overflow: auto }
    pre { margin: 0; white-space: pre-wrap }
    textarea {
      width: 100%; min-height: 160px; background: var(--code-bg);
      color: #2c7a3f; font-family: ui-monospace, Menlo, Consolas, monospace;
      padding: 12px; border-radius: 12px; border: 1px solid #18202b;
    }
    .btns { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px }
    button {
      appearance: none; background: var(--accent); color: white; border: none; border-radius: 10px;
      padding: 10px 14px; cursor: pointer; font-weight: 600; box-shadow: 0 8px 20px rgba(10,162,184,0.35);
    }
    button.secondary { background: #2f3545; color: #fff }
    button.success { background: var(--accent-2) }
    button.danger { background: var(--danger) }
    button.warn { background: var(--warn); color: #1c1300 }
    .alert {
      padding: 10px 12px; border-radius: 10px; background: rgba(76,175,80,.12);
      border: 1px solid rgba(76,175,80,.4); color: #2e7d32; margin: 10px 0; display: none;
    }
    .install-banner { display: none; align-items: center; gap: 10px; margin: 10px 0; padding: 10px; border-radius: 12px; border: 1px dashed var(--border); background: rgba(255,255,255,0.06) }
    .kbd { font-family: ui-monospace, Menlo, Consolas, monospace; background: rgba(255,255,255,0.08); padding: 1px 6px; border-radius: 6px; border: 1px solid var(--border) }
    footer { margin-top: 18px; border-top: 1px solid var(--border); background: var(--glass); backdrop-filter: blur(12px) }
    .muted { color: var(--muted) }
    .progress-wrap { display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    .progress-bar { width: 220px; height: 10px; background: rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; border: 1px solid var(--border) }
    .progress-bar > div { height: 100%; background: var(--accent-2); width: 0% }
    .badge { padding: 6px 10px; border-radius: 999px; border:1px solid var(--border); display:inline-flex; align-items:center; gap:6px; background: rgba(255,255,255,0.06) }
    /* ØªÙ„ÙˆÙŠÙ† Ù†Ø­ÙˆÙŠ Ø¨Ø³ÙŠØ· */
    .hl .kw { color:#c792ea; font-weight:600 }
    .hl .fn { color:#82aaff }
    .hl .num { color:#f78c6c }
    .hl .str { color:#aeea00 }
    .hl .com { color:#94a3b8; font-style:italic }
    /* Ù…Ø®Ø·Ø· Ø¨Ø³ÙŠØ· */
    .chart { width:100%; height:180px; border:1px solid var(--border); border-radius:12px; background: rgba(255,255,255,0.06) }
    /* Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„: ØªØ±ÙƒÙŠØ² ÙˆØ§Ø¶Ø­ */
    :focus-visible { outline: 3px solid #ffcc00; outline-offset: 2px }
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="logo" id="dynamic-logo" aria-hidden="true">A</div>
      <div>
        <h1>ØªØ¹Ù„Ù… Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø£Ø±Ø¯ÙˆÙŠÙ†Ùˆ</h1>
        <div class="pill" id="subtitle">ÙˆØ§Ø¬Ù‡Ø© Ø²Ø¬Ø§Ø¬ÙŠØ© â€¢ SPA â€¢ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ â€¢ Ù…ÙŠØ²Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</div>
        <nav>
          <a href="#/" class="nav-link" data-link="home" aria-label="Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <a href="#/lesson/1" class="nav-link" data-link="l1">Ø¯Ø±Ø³ 1</a>
          <a href="#/lesson/2" class="nav-link" data-link="l2">Ø¯Ø±Ø³ 2</a>
          <a href="#/lesson/3" class="nav-link" data-link="l3">Ø¯Ø±Ø³ 3</a>
          <a href="#/lesson/4" class="nav-link" data-link="l4">Ø¯Ø±Ø³ 4</a>
          <a href="#/lesson/5" class="nav-link" data-link="l5">Ø¯Ø±Ø³ 5</a>
          <a href="#/lesson/6" class="nav-link" data-link="l6">Ø¯Ø±Ø³ 6</a>
          <a href="#/lesson/7" class="nav-link" data-link="l7">Ø¯Ø±Ø³ 7</a>
          <a href="#/lesson/8" class="nav-link" data-link="l8">Ø¯Ø±Ø³ 8</a>
          <a href="#/lesson/9" class="nav-link" data-link="l9">Ø¯Ø±Ø³ 9</a>
          <a href="#/lesson/10" class="nav-link" data-link="l10">Ø¯Ø±Ø³ 10</a>
          <button id="themeToggle" class="secondary" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…</button>
          <button id="exportBtn" class="warn">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø¯Ù…</button>
          <button id="importBtn" class="warn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù…</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Ù„ÙˆØ­Ø© Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© -->
    <section class="card" id="overview">
      <h2>ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© ÙˆØªÙ‚Ø¯Ù‘Ù…Ùƒ</h2>
      <div class="grid">
        <div>
          <div class="progress-wrap">
            <div class="badge">Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: <span id="completedCount">0</span> / <span id="totalCount">10</span></div>
            <div class="progress-bar" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…"><div id="progressBar"></div></div>
            <div class="badge">Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: <span id="lastActivity">â€”</span></div>
          </div>
          <canvas id="progressChart" class="chart" aria-label="Ù…Ø®Ø·Ø· Ø§Ù„ØªÙ‚Ø¯Ù…"></canvas>
        </div>
        <div>
          <div class="badge">Ø¨Ø§Ø¯Ø¬Ø§ØªÙƒ:</div>
          <div id="badges" style="display:flex; gap:8px; flex-wrap:wrap"></div>
        </div>
      </div>
    </section>

    <!-- Ø¨Ø­Ø« -->
    <section class="card" id="searchSection">
      <h2>ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¯Ø±ÙˆØ³</h2>
      <div class="grid">
        <div>
          <input id="searchInput" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø±Ø³ Ø£Ùˆ Ù…ØµØ·Ù„Ø­ (PWM, I2C, Servo)..." style="width:100%; padding:10px; border-radius:10px; border:1px solid var(--border)" />
          <p class="muted" id="searchHint">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø³ØªØ¸Ù‡Ø± Ø£Ø³ÙÙ„Ù‹Ø§ Ù…Ø¹ Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„ÙƒÙ„Ù…Ø§Øª.</p>
          <div class="lessons-grid" id="searchResults"></div>
        </div>
        <div>
          <div class="pill">Ù†ØµÙŠØ­Ø©</div>
          <p>Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù‚ØµÙŠØ±Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¬Ù…Ø¹ Ø¨ÙŠÙ† ÙƒÙ„Ù…Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© ÙˆØ³ÙŠØªÙ… Ø¥Ø¨Ø±Ø§Ø²Ù‡Ø§ ÙÙŠ Ø§Ù„Ù†Øµ.</p>
        </div>
      </div>
    </section>

    <!-- ØµÙØ­Ø© Ø±Ø¦ÙŠØ³ÙŠØ© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ -->
    <section class="card" id="homePage">
      <h2>ğŸ“š Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</h2>
      <p class="muted">Ø§Ø®ØªØ± Ø¯Ø±Ø³Ù‹Ø§ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ù„Ù…. ÙƒÙ„ Ø¯Ø±Ø³ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙÙŠØ¯ÙŠÙˆØŒ Ø´Ø±Ø­ØŒ Ù…Ø­Ø±Ø± ÙƒÙˆØ¯ØŒ Ø§Ù…ØªØ­Ø§Ù† Ù…ØªØ§Ø¨Ø¹Ø©ØŒ ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©.</p>
      <div class="lessons-grid" id="lessonsList"></div>
    </section>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„ÙØ±Ø¹ÙŠØ© -->
    <section class="card" id="lessonPage" style="display:none">
      <h2 id="lessonTitle">ğŸ“ Ø¯Ø±Ø³</h2>
      <div class="grid">
        <div>
          <h3>ğŸ¥ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¯Ø±Ø³</h3>
          <video class="media" controls id="lessonVideo" preload="none">
            <source id="lessonVideoSrc" src="" type="video/mp4" />
            Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.
          </video>
          <p id="lessonIntro" class="muted"></p>

          <h3>ğŸ’» ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙƒÙˆØ¯</h3>
          <div class="btns">
            <button id="templateBlink">Ù‚Ø§Ù„Ø¨: Blink</button>
            <button id="templateButton" class="secondary">Ù‚Ø§Ù„Ø¨: Button</button>
            <button id="templateServo" class="secondary">Ù‚Ø§Ù„Ø¨: Servo</button>
            <button id="templateSensor" class="secondary">Ù‚Ø§Ù„Ø¨: Sensor</button>
          </div>
          <div class="code hl" id="highlighted"><pre id="highlightedPre"></pre></div>
          <textarea id="lessonEditor" aria-label="Ù…Ø­Ø±Ø± Ø§Ù„ÙƒÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³"></textarea>
          <div class="btns">
            <button id="runLessonBtn">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
            <button class="secondary" id="resetLessonBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
            <button class="success" id="saveLessonBtn">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…</button>
            <button class="danger" id="clearLessonBtn">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ÙÙˆØ¸</button>
          </div>
          <div id="lessonSavedAlert" class="alert" role="status">ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ âœ…</div>

          <h3>ğŸ–¥ï¸ Ù†Ø§ÙØ°Ø© Serial</h3>
          <div class="code"><pre id="lessonOutput">// Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</pre></div>
          <div class="btns">
            <input id="serialInput" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¯Ø®Ù„Ù‹Ø§ ÙƒÙ…Ø§ Ù„Ùˆ Ø£Ù†Ù‡ Ø¢ØªÙ Ù…Ù† Serial..." style="flex:1; padding:10px; border-radius:10px; border:1px solid var(--border)" />
            <button id="sendSerial" class="secondary">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¯Ø®Ø§Ù„</button>
          </div>

          <h3>ğŸ§¯ ÙØ­Øµ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ÙƒÙˆØ¯</h3>
          <div id="lintPanel" class="lesson-card"></div>

          <h3>ğŸ“ Ø§Ù…ØªØ­Ø§Ù† Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠ</h3>
          <div id="quizContainer"></div>
          <div id="quizResult" class="alert">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
        </div>

        <div>
          <h3>ğŸ—’ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ</h3>
          <textarea id="notesArea" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ ÙˆØ£ÙÙƒØ§Ø±Ùƒ Ø­ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø³ Ù‡Ù†Ø§..."></textarea>
          <div class="btns">
            <button class="success" id="saveNotesBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
          </div>
          <div id="notesSavedAlert" class="alert">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ âœ…</div>

          <h3 style="margin-top:18px">ğŸ† Ø´Ù‡Ø§Ø¯Ø© Ø¥ØªÙ…Ø§Ù…</h3>
          <p class="muted">Ø¹Ù†Ø¯ Ø¥ÙƒÙ…Ø§Ù„ 70% Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙˆÙ„ÙŠØ¯ Ø´Ù‡Ø§Ø¯Ø© PDF Ù…Ø¨Ø³Ø·Ø©.</p>
          <div class="btns">
            <button id="generateCert" class="warn">ØªÙˆÙ„ÙŠØ¯ Ø´Ù‡Ø§Ø¯Ø©</button>
          </div>

          <h3 style="margin-top:18px">ğŸ“¦ Ø§Ù„ØªØ«Ø¨ÙŠØª ÙƒØªØ·Ø¨ÙŠÙ‚ (PWA)</h3>
          <div class="install-banner" id="installBanner">
            <span>ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙƒØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</span>
            <button id="installBtn">ØªØ«Ø¨ÙŠØª</button>
          </div>
          <p class="muted">ÙŠÙØ¶Ù‘Ù„ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± http:// Ø£Ùˆ https:// Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ«Ø¨ÙŠØª ÙˆØ§Ù„Ø®Ø¯Ù…Ø©.</p>

          <h3 style="margin-top:18px">ğŸ› ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3>
          <div class="lesson-card">
            <p><strong>Ø£Ø¶Ù Ø¯Ø±Ø³Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§:</strong></p>
            <div class="btns" style="gap:6px">
              <input id="adminTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³" style="flex:1; padding:8px; border-radius:8px; border:1px solid var(--border)" />
              <input id="adminVideo" placeholder="Ù…Ø³Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (mp4)" style="flex:1; padding:8px; border-radius:8px; border:1px solid var(--border)" />
            </div>
            <textarea id="adminIntro" placeholder="Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„Ø¯Ø±Ø³"></textarea>
            <textarea id="adminCode" placeholder="ÙƒÙˆØ¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ"></textarea>
            <div class="btns">
              <button id="adminAdd" class="success">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³</button>
            </div>
            <div id="adminAlert" class="alert">ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±Ø³ âœ…</div>
          </div>

          <h3 style="margin-top:18px">ğŸªµ Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡</h3>
          <div class="code"><pre id="activityLog">// Ø§Ù„Ø³Ø¬Ù„ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...</pre></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap">
      <p class="muted" id="footerText">Â© ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø±Ø¯ÙˆÙŠÙ†Ùˆ â€¢ ÙˆØ§Ø¬Ù‡Ø© Ø²Ø¬Ø§Ø¬ÙŠØ© â€¢ SPA â€¢ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ â€¢ Ù…ÙŠØ²Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</p>
    </div>
  </footer>

  <script>
    // ========== Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ==========
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function logActivity(msg){
      const t = new Date().toLocaleString();
      const prev = localStorage.getItem('activity-log') || '';
      const line = `[${t}] ${msg}\n`;
      localStorage.setItem('activity-log', prev + line);
      $('#activityLog').textContent = (prev + line).split('\n').slice(-100).join('\n') || '// Ø§Ù„Ø³Ø¬Ù„ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...';
      $('#lastActivity').textContent = t;
    }
    window.addEventListener('error', e => {
      logActivity(`Ø®Ø·Ø£: ${e.message}`);
    });

    // ========== ØªÙˆÙ„ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ==========
    function generateIcon(size = 192) {
      const c = document.createElement('canvas'); c.width = size; c.height = size;
      const ctx = c.getContext('2d');
      const grd = ctx.createLinearGradient(0,0,size,size);
      grd.addColorStop(0, '#12c2e9'); grd.addColorStop(1, '#0aa2b8');
      ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(size/2, size/2, size/2 - 8, 0, Math.PI*2); ctx.fill();
      ctx.lineWidth = Math.max(8, size*0.06); ctx.strokeStyle = '#08343f';
      ctx.beginPath(); ctx.arc(size*0.38, size*0.5, size*0.16, 0, Math.PI*2); ctx.stroke();
      ctx.beginPath(); ctx.arc(size*0.62, size*0.5, size*0.16, 0, Math.PI*2); ctx.stroke();
      ctx.lineWidth = Math.max(6, size*0.045);
      ctx.beginPath();
      ctx.moveTo(size*0.38, size*0.43); ctx.lineTo(size*0.38, size*0.57);
      ctx.moveTo(size*0.31, size*0.5); ctx.lineTo(size*0.45, size*0.5);
      ctx.moveTo(size*0.62, size*0.43); ctx.lineTo(size*0.62, size*0.57);
      ctx.moveTo(size*0.55, size*0.5); ctx.lineTo(size*0.69, size*0.5);
      ctx.stroke();
      return c.toDataURL('image/png');
    }
    (function showMiniIcon(){
      const el = $('#dynamic-logo');
      const url = generateIcon(64);
      el.style.backgroundImage = `url(${url})`;
      el.style.backgroundSize = 'cover';
      el.textContent = '';
    })();

    // ========== ØªØ¹Ø¯Ø¯ Ù„ØºØ§Øª Ø¨Ø³ÙŠØ· ==========
    const i18n = {
      ar: {
        subtitle: "ÙˆØ§Ø¬Ù‡Ø© Ø²Ø¬Ø§Ø¬ÙŠØ© â€¢ SPA â€¢ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ â€¢ Ù…ÙŠØ²Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©",
        footer: "Â© ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø±Ø¯ÙˆÙŠÙ†Ùˆ â€¢ ÙˆØ§Ø¬Ù‡Ø© Ø²Ø¬Ø§Ø¬ÙŠØ© â€¢ SPA â€¢ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ â€¢ Ù…ÙŠØ²Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©",
        searchHint: "Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø³ØªØ¸Ù‡Ø± Ø£Ø³ÙÙ„Ù‹Ø§ Ù…Ø¹ Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„ÙƒÙ„Ù…Ø§Øª."
      },
      en: {
        subtitle: "Glass UI â€¢ SPA â€¢ Single file â€¢ Advanced features",
        footer: "Â© Arduino Learning â€¢ Glass UI â€¢ SPA â€¢ Single file",
        searchHint: "Search results appear below with highlighted keywords."
      }
    };
    const userLang = localStorage.getItem('lang') || 'ar';
    function applyLang(lang){
      document.documentElement.lang = lang;
      localStorage.setItem('lang', lang);
      $('#subtitle').textContent = i18n[lang].subtitle;
      $('#footerText').textContent = i18n[lang].footer;
      $('#searchHint').textContent = i18n[lang].searchHint;
    }
    applyLang(userLang);

    // ========== Ø«ÙŠÙ… Ø¯Ø§ÙƒÙ†/ÙØ§ØªØ­ ==========
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme === 'light' ? 'light' : 'dark');
    $('#themeToggle').addEventListener('click', () => {
      const now = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', now);
      localStorage.setItem('theme', now);
      logActivity(`ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… Ø¥Ù„Ù‰: ${now}`);
    });

    // ========== Ø¨ÙŠØ§Ù†Ø§Øª 10 Ø¯Ø±ÙˆØ³ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙˆØ³ÙŠØ¹) ==========
    const lessons = [
      { id:1, title:"Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ÙˆÙˆÙ…ÙŠØ¶ Ø§Ù„Ù„ÙŠØ¯", video:"lesson1.mp4", intro:"ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…Ù†ØµØ© Ø§Ù„Ø£Ø±Ø¯ÙˆÙŠÙ†Ùˆ ÙˆØªØ¬Ø±Ø¨Ø© Ø£ÙˆÙ„ Ù…Ø´Ø±ÙˆØ¹: ÙˆÙ…ÙŠØ¶ Ø§Ù„Ù„ÙŠØ¯.", defaultCode:
`// Blink LED
void setup() { pinMode(LED_BUILTIN, OUTPUT); }
void loop() {
  digitalWrite(LED_BUILTIN, HIGH); delay(1000);
  digitalWrite(LED_BUILTIN, LOW);  delay(1000);
}`, tags:["blink","basics","digital"], quizBank:[
        { q:"Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªÙÙ†ÙÙ‘Ø° Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©ØŸ", choices:["setup()","loop()"], answer:0, cat:"basics" },
        { q:"Ø§Ù„Ù…Ø³Ù…Ø§Ø± Ù„Ù„Ù‘ÙŠØ¯ Ø§Ù„Ù…Ø¯Ù…Ø¬ØŸ", choices:["LED_BUILTIN","A0"], answer:0, cat:"digital" },
        { q:"ÙˆØ¸ÙŠÙØ© delayØŸ", choices:["ØªØ£Ø®ÙŠØ± Ø­Ø§Ø¬Ø²","Ù‚Ø±Ø§Ø¡Ø© ØªÙ†Ø§Ø¸Ø±ÙŠØ©"], answer:0, cat:"timing" }
      ]
      },
      { id:2, title:"Ø²Ø± Ø§Ù„Ø¶ØºØ·", video:"lesson2.mp4", intro:"Ù‚Ø±Ø§Ø¡Ø© Ø²Ø± Ø¶ØºØ· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… INPUT_PULLUP.", defaultCode:
`int button=2;
void setup(){ pinMode(button, INPUT_PULLUP); pinMode(LED_BUILTIN, OUTPUT); }
void loop(){ bool pressed = digitalRead(button)==LOW; digitalWrite(LED_BUILTIN, pressed?HIGH:LOW); }`, tags:["button","digital"], quizBank:[
        { q:"Ø³Ø¨Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… INPUT_PULLUPØŸ", choices:["Ù…Ù‚Ø§ÙˆÙ…Ø© Ø³Ø­Ø¨ Ø¯Ø§Ø®Ù„ÙŠØ©","ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬"], answer:0, cat:"digital" },
        { q:"Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø²Ø± Ù…Ø¹ Pullup Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·ØŸ", choices:["LOW","HIGH"], answer:0, cat:"digital" }
      ]
      },
      { id:3, title:"Ø­Ø³Ø§Ø³ Ø¶ÙˆØ¦ÙŠ", video:"lesson3.mp4", intro:"Ù‚Ø±Ø§Ø¡Ø© Ø­Ø³Ø§Ø³ Ø¶ÙˆØ¦ÙŠ Ø¹Ù„Ù‰ A0 Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… analogRead.", defaultCode:
`int sensor=A0;
void setup(){ Serial.begin(9600); }
void loop(){ int v=analogRead(sensor); Serial.println(v); delay(500); }`, tags:["sensor","analog","serial"], quizBank:[
        { q:"Ù…Ø¯Ù‰ analogRead (Uno)ØŸ", choices:["0-1023","0-255"], answer:0, cat:"analog" },
        { q:"Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠØ©ØŸ", choices:["Serial.println()","pinMode()"], answer:0, cat:"serial" }
      ]
      },
      { id:4, title:"PWM Ø³Ø·ÙˆØ¹", video:"lesson4.mp4", intro:"Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø³Ø·ÙˆØ¹ Ø¹Ø¨Ø± analogWrite.", defaultCode:
`int led=9;
void setup(){ pinMode(led, OUTPUT); }
void loop(){
  for(int i=0;i<=255;i++){ analogWrite(led,i); delay(5); }
  for(int i=255;i>=0;i--){ analogWrite(led,i); delay(5); }
}`, tags:["pwm","analogWrite"], quizBank:[
        { q:"Ù‚ÙŠÙ… analogWriteØŸ", choices:["0-255","0-1023"], answer:0, cat:"pwm" },
        { q:"Ù‡Ù„ ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§Ù…ÙŠØ± PWMØŸ", choices:["Ù„Ø§","Ù†Ø¹Ù…"], answer:0, cat:"pwm" }
      ]
      },
      { id:5, title:"millis Ø¨Ø¯ÙˆÙ† Ø­Ø¬Ø¨", video:"lesson5.mp4", intro:"Ø§Ø³ØªØ®Ø¯Ø§Ù… millis Ø¨Ø¯Ù„ delay Ù„Ø¨Ù†Ø§Ø¡ Ù…Ù†Ø·Ù‚ ØºÙŠØ± Ø­Ø§Ø¬Ø².", defaultCode:
`unsigned long last=0; const unsigned long interval=1000;
void setup(){ pinMode(LED_BUILTIN, OUTPUT); }
void loop(){
  unsigned long now=millis();
  if(now-last>=interval){ last=now; digitalWrite(LED_BUILTIN, !digitalRead(LED_BUILTIN)); }
}`, tags:["timing","millis"], quizBank:[
        { q:"delay Ù…Ù‚Ø§Ø¨Ù„ millisØŸ", choices:["delay ÙŠØ­Ø¬Ø¨","millis ÙŠØ­Ø¬Ø¨"], answer:0, cat:"timing" },
        { q:"ÙˆØ­Ø¯Ø© millisØŸ", choices:["Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©","Ø«Ø§Ù†ÙŠØ©"], answer:0, cat:"timing" }
      ]
      },
      { id:6, title:"Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª", video:"lesson6.mp4", intro:"Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù…Ø¹ Library Manager.", defaultCode:
`#include <Wire.h>
void setup(){ Wire.begin(); Serial.begin(9600); Serial.println("Ready"); }
void loop(){ /* I2C */ }`, tags:["libraries","i2c"], quizBank:[
        { q:"Ø£ÙŠÙ† ØªØ¶ÙŠÙ Ø§Ù„Ù…ÙƒØªØ¨Ø§ØªØŸ", choices:["Library Manager","Board Manager"], answer:0, cat:"libraries" },
        { q:"Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ SDA/SCLØŸ", choices:["I2C","SPI"], answer:0, cat:"i2c" }
      ]
      },
      { id:7, title:"Serial Ù…ØªÙ‚Ø¯Ù…", video:"lesson7.mp4", intro:"Ø§Ù„ØªØ®Ø§Ø·Ø¨ Ø¹Ø¨Ø± Serial Ù…Ø¹ Ø§Ù„Ø­Ø§Ø³ÙˆØ¨.", defaultCode:
`void setup(){ Serial.begin(9600); }
void loop(){
  if(Serial.available()){
    char c=Serial.read();
    Serial.print("You typed: "); Serial.println(c);
  }
}`, tags:["serial"], quizBank:[
        { q:"Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§ÙŠØªØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©ØŸ", choices:["Serial.available()","Serial.begin()"], answer:0, cat:"serial" },
        { q:"Ø¨ÙˆØ¯ Ø±ÙŠØª Ø´Ø§Ø¦Ø¹ØŸ", choices:["9600","1"], answer:0, cat:"serial" }
      ]
      },
      { id:8, title:"Servo", video:"lesson8.mp4", intro:"ØªØ­Ø±ÙŠÙƒ Ø³ÙŠØ±ÙÙˆ Ø¹Ø¨Ø± Ù…ÙƒØªØ¨Ø© Servo.", defaultCode:
`#include <Servo.h>
Servo s;
void setup(){ s.attach(9); }
void loop(){ for(int a=0;a<=180;a+=10){ s.write(a); delay(200); } }`, tags:["servo"], quizBank:[
        { q:"Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù„Ù„Ø³ÙŠØ±ÙÙˆØŸ", choices:["Servo","Wire"], answer:0, cat:"servo" },
        { q:"Ù…Ø¯Ù‰ Ø§Ù„Ø²ÙˆØ§ÙŠØ§ØŸ", choices:["0-180","0-360"], answer:0, cat:"servo" }
      ]
      },
      { id:9, title:"Ù„Ø§Ø³Ù„ÙƒÙŠ Ø£Ø³Ø§Ø³ÙŠ", video:"lesson9.mp4", intro:"Ù…Ù‚Ø¯Ù…Ø© Ø¹Ù† NRF24L01 ÙˆHC-05.", defaultCode:
`void setup(){ Serial.begin(9600); Serial.println("Wireless intro"); }
void loop(){ /* Ø¥Ø±Ø³Ø§Ù„/Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ */ }`, tags:["wireless"], quizBank:[
        { q:"ÙˆØ­Ø¯Ø© Ø¨Ù„ÙˆØªÙˆØ« Ø´Ø§Ø¦Ø¹Ø©ØŸ", choices:["HC-05","ESP-01"], answer:0, cat:"wireless" },
        { q:"NRF24L01 ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ØŸ", choices:["2.4GHz RF","I2C ÙÙ‚Ø·"], answer:0, cat:"wireless" }
      ]
      },
      { id:10, title:"Ù…Ø´Ø±ÙˆØ¹: Ù…Ø­Ø·Ø© Ø·Ù‚Ø³", video:"lesson10.mp4", intro:"Ø¬Ù…Ø¹ Ù‚Ø±Ø§Ø¡Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ø¹Ø¨Ø± Serial.", defaultCode:
`void setup(){ Serial.begin(9600); }
void loop(){
  int temp=25; int hum=60;
  Serial.print("T: "); Serial.print(temp);
  Serial.print(" C, H: "); Serial.print(hum); Serial.println(" %");
  delay(1000);
}`, tags:["project","weather"], quizBank:[
        { q:"Ù†ÙˆØ¹ Ø§Ù„Ù…ØªØºÙŠØ± Ù„Ù„Ø­Ø±Ø§Ø±Ø©ØŸ", choices:["int/float","char"], answer:0, cat:"project" },
        { q:"ÙˆØ¸ÙŠÙØ© Serial.printØŸ", choices:["Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ù…ÙŠØ±"], answer:0, cat:"serial" }
      ]
      }
    ];
    // Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³
    $('#totalCount').textContent = lessons.length.toString();

    // ========== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==========
    const lessonsList = $('#lessonsList');
    function lessonCard(ls){
      const div = document.createElement('div');
      div.className = 'lesson-card';
      const tags = ls.tags.map(t => `<span class="pill">${t}</span>`).join(' ');
      div.innerHTML = `
        <h3>ğŸ“ ${ls.title}</h3>
        <p class="muted">${ls.intro}</p>
        <div style="display:flex; gap:8px; flex-wrap:wrap">${tags}</div>
        <div class="actions">
          <a class="nav-link" href="#/lesson/${ls.id}">Ø§ÙØªØ­ Ø§Ù„Ø¯Ø±Ø³</a>
          <span class="pill">Ø¯Ø±Ø³ Ø±Ù‚Ù… ${ls.id}</span>
        </div>
      `;
      return div;
    }
    function renderHome(){
      lessonsList.innerHTML = '';
      lessons.forEach(ls => lessonsList.appendChild(lessonCard(ls)));
    }

    // ========== Ø¨Ø­Ø« ==========
    const searchInput = $('#searchInput');
    const searchResults = $('#searchResults');
    function highlight(text, terms){
      let out = text;
      terms.forEach(t => {
        const re = new RegExp(`(${t})`, 'ig');
        out = out.replace(re, '<mark>$1</mark>');
      });
      return out;
    }
    function doSearch(){
      const q = searchInput.value.trim();
      searchResults.innerHTML = '';
      if (!q){ return; }
      const terms = q.split(/\s+/).filter(Boolean);
      const hits = lessons.filter(ls => {
        const blob = `${ls.title} ${ls.intro} ${ls.tags.join(' ')}`;
        return terms.every(t => blob.toLowerCase().includes(t.toLowerCase()));
      });
      hits.forEach(ls => {
        const card = document.createElement('div');
        card.className = 'lesson-card';
        card.innerHTML = `
          <h3>ğŸ“ ${highlight(ls.title, terms)}</h3>
          <p class="muted">${highlight(ls.intro, terms)}</p>
          <div class="actions">
            <a class="nav-link" href="#/lesson/${ls.id}">Ø§ÙØªØ­ Ø§Ù„Ø¯Ø±Ø³</a>
          </div>`;
        searchResults.appendChild(card);
      });
    }
    searchInput.addEventListener('input', doSearch);

    // ========== Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ==========
    const homePage = $('#homePage');
    const lessonPage = $('#lessonPage');
    const lessonTitle = $('#lessonTitle');
    const lessonVideoSrc = $('#lessonVideoSrc');
    const lessonIntro = $('#lessonIntro');
    const lessonEditor = $('#lessonEditor');
    const lessonOutput = $('#lessonOutput');
    const lessonSavedAlert = $('#lessonSavedAlert');
    const quizContainer = $('#quizContainer');
    const quizResult = $('#quizResult');
    const notesArea = $('#notesArea');
    const notesSavedAlert = $('#notesSavedAlert');
    const highlightedPre = $('#highlightedPre');
    let currentLessonId = null;

    function setActiveNav(){
      $$('.nav-link').forEach(a => a.classList.remove('active'));
      const hash = location.hash || '#/';
      const match = document.querySelector(`.nav-link[href="${hash}"]`);
      if (match) match.classList.add('active');
    }
    function route(){
      const hash = location.hash || '#/';
      setActiveNav();
      if (hash === '#/' || hash === '#') {
        overview.style.display = 'block';
        $('#searchSection').style.display = 'block';
        homePage.style.display = 'block';
        lessonPage.style.display = 'none';
        renderHome();
        renderProgressPanel();
        return;
      }
      const m = hash.match(/^#\/lesson\/(\d+)$/);
      if (m){
        overview.style.display = 'none';
        $('#searchSection').style.display = 'none';
        const id = parseInt(m[1], 10);
        const ls = lessons.find(x => x.id === id);
        if (!ls){ location.hash = '#/'; return; }
        currentLessonId = id;
        homePage.style.display = 'none';
        lessonPage.style.display = 'block';
        lessonTitle.textContent = `ğŸ“ ${ls.title}`;
        lessonVideoSrc.src = ls.video || '';
        $('#lessonVideo').load();
        lessonIntro.textContent = ls.intro;
        // Load editor content
        const savedCode = localStorage.getItem(`lesson-${id}-code`);
        lessonEditor.value = savedCode ?? ls.defaultCode;
        renderHighlight();
        lessonOutput.textContent = '// Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...';
        // Notes
        const savedNotes = localStorage.getItem(`lesson-${id}-notes`);
        notesArea.value = savedNotes ?? '';
        // Quiz render (Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©)
        renderQuiz(ls.quizBank);
        const savedScore = localStorage.getItem(`lesson-${id}-quiz`);
        if (savedScore){
          quizResult.style.display = 'block';
          const {score, answered} = JSON.parse(savedScore);
          quizResult.textContent = `Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©: ${score}/${answered}`;
        } else {
          quizResult.style.display = 'none';
        }
        logActivity(`ÙØªØ­ Ø§Ù„Ø¯Ø±Ø³ ${id}: ${ls.title}`);
      } else {
        location.hash = '#/';
      }
    }
    window.addEventListener('hashchange', route);

    // ========== ØªÙ„ÙˆÙŠÙ† Ù†Ø­ÙˆÙŠ Ø¨Ø³ÙŠØ· ==========
    function renderHighlight(){
      const code = lessonEditor.value;
      let h = code;
      h = h.replace(/(\/\/.*?$)/mg, '<span class="com">$1</span>');
      h = h.replace(/\b(void|int|float|bool|char|for|if|else|return|include)\b/g, '<span class="kw">$1</span>');
      h = h.replace(/\b(Serial|pinMode|digitalWrite|digitalRead|analogRead|analogWrite|delay|millis|println|print|begin|available|read|attach|write)\b/g, '<span class="fn">$1</span>');
      h = h.replace(/("[^"]*")/g, '<span class="str">$1</span>');
      h = h.replace(/\b(\d+)\b/g, '<span class="num">$1</span>');
      highlightedPre.innerHTML = h;
    }
    lessonEditor.addEventListener('input', renderHighlight);

    // ========== Ù‚ÙˆØ§Ù„Ø¨ Ø¬Ø§Ù‡Ø²Ø© ==========
    const templates = {
      blink: `// Blink LED
void setup(){ pinMode(LED_BUILTIN, OUTPUT); }
void loop(){ digitalWrite(LED_BUILTIN,HIGH); delay(500); digitalWrite(LED_BUILTIN,LOW); delay(500); }`,
      button: `int button=2;
void setup(){ pinMode(button, INPUT_PULLUP); pinMode(LED_BUILTIN, OUTPUT); }
void loop(){ bool pressed=digitalRead(button)==LOW; digitalWrite(LED_BUILTIN, pressed?HIGH:LOW); }`,
      servo: `#include <Servo.h>
Servo s; void setup(){ s.attach(9); }
void loop(){ for(int a=0;a<=180;a+=10){ s.write(a); delay(100); } }`,
      sensor: `int sensor=A0;
void setup(){ Serial.begin(9600); }
void loop(){ int v=analogRead(sensor); Serial.println(v); delay(500); }`
    };
    $('#templateBlink').addEventListener('click', ()=>{ lessonEditor.value=templates.blink; renderHighlight(); });
    $('#templateButton').addEventListener('click', ()=>{ lessonEditor.value=templates.button; renderHighlight(); });
    $('#templateServo').addEventListener('click', ()=>{ lessonEditor.value=templates.servo; renderHighlight(); });
    $('#templateSensor').addEventListener('click', ()=>{ lessonEditor.value=templates.sensor; renderHighlight(); });

    // ========== ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© (Serial.print/println) ==========
    const serialBuffer = [];
    function simulateRun(code){
      // Ø·Ø¨Ø§Ø¹Ø© println
      const printlnMatches = code.match(/Serial\.println\((.*?)\);/g) || [];
      const printMatches   = code.match(/Serial\.print\((.*?)\);/g) || [];
      const lines = [];
      const evalArg = (inner) => {
        try { return String(Function(`return (${inner})`)()); } catch { return String(inner); }
      };
      printlnMatches.forEach(m => {
        const inner = m.replace(/^Serial\.println\(/,'').replace(/\);\s*$/,'');
        lines.push(evalArg(inner));
      });
      // Ø¯Ù…Ø¬ print ÙƒØ®Ø· ÙˆØ§Ø­Ø¯ (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
      let lineBuf = '';
      printMatches.forEach(m => {
        const inner = m.replace(/^Serial\.print\(/,'').replace(/\);\s*$/,'');
        lineBuf += evalArg(inner);
      });
      if (lineBuf) lines.push(lineBuf);
      return lines.length ? lines.join('\n') : 'â€”';
    }
    $('#runLessonBtn').addEventListener('click', () => {
      const out = simulateRun(lessonEditor.value);
      lessonOutput.textContent = out;
      logActivity(`ØªØ´ØºÙŠÙ„ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¯Ø±Ø³ ${currentLessonId}`);
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù…: Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø®Ø·ÙˆØ© Ø¥ÙƒÙ…Ø§Ù„
      markLessonProgress(currentLessonId, 'run');
      renderProgressPanel();
    });
    $('#resetLessonBtn').addEventListener('click', () => {
      const ls = lessons.find(x => x.id === currentLessonId);
      if (!ls) return;
      lessonEditor.value = ls.defaultCode;
      renderHighlight();
      lessonOutput.textContent = '// Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...';
    });
    $('#saveLessonBtn').addEventListener('click', () => {
      if (!currentLessonId) return;
      try {
        localStorage.setItem(`lesson-${currentLessonId}-code`, lessonEditor.value);
        lessonSavedAlert.style.display = 'block';
        setTimeout(() => lessonSavedAlert.style.display = 'none', 2000);
        logActivity(`Ø­ÙØ¸ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø±Ø³ ${currentLessonId}`);
      } catch {}
    });
    $('#clearLessonBtn').addEventListener('click', () => {
      if (!currentLessonId) return;
      localStorage.removeItem(`lesson-${currentLessonId}-code`);
      localStorage.removeItem(`lesson-${currentLessonId}-quiz`);
      localStorage.removeItem(`lesson-${currentLessonId}-notes`);
      lessonOutput.textContent = '// Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...';
      notesArea.value = '';
      quizResult.style.display = 'none';
      logActivity(`Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±Ø³ ${currentLessonId}`);
    });

    // Ù†Ø§ÙØ°Ø© Serial Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø­Ø§ÙƒØ§Ø©
    $('#sendSerial').addEventListener('click', () => {
      const v = $('#serialInput').value;
      if (!v) return;
      serialBuffer.push(v);
      lessonOutput.textContent += `\n[IN] ${v}`;
      $('#serialInput').value = '';
    });

    // ========== ÙØ­Øµ Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø¨Ø³Ø· ==========
    function lintCode(code){
      const issues = [];
      // ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… delay Ø·ÙˆÙŠÙ„
      if (code.match(/delay\(\s*(\d{4,})\s*\)/)) issues.push({type:'warn', msg:'Ø§Ø³ØªØ®Ø¯Ø§Ù… delay Ø·ÙˆÙŠÙ„ Ù‚Ø¯ ÙŠØ­Ø¬Ø¨ Ø§Ù„ØªÙ†ÙÙŠØ°. ÙÙƒÙ‘Ø± ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… millis.'});
      // ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… Serial.println Ø¨Ø¯ÙˆÙ† Serial.begin
      if (code.match(/Serial\.(print|println)\(/) && !code.match(/Serial\.begin\(/)) issues.push({type:'warn', msg:'ØªØ³ØªØ®Ø¯Ù… Serial Ø¨Ø¯ÙˆÙ† ØªÙ‡ÙŠØ¦Ø© Serial.begin(9600).'});
      // ØªØ­Ø°ÙŠØ±: Ù‚Ø±Ø§Ø¡Ø©/ÙƒØªØ§Ø¨Ø© Ø¨Ø¯ÙˆÙ† pinMode
      if (code.match(/digital(Read|Write)\(/) && !code.match(/pinMode\(/)) issues.push({type:'warn', msg:'ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø³Ø§Ù…ÙŠØ± Ø¹Ø¨Ø± pinMode Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©/Ø§Ù„ÙƒØªØ§Ø¨Ø©.'});
      // Ù…Ø¹Ù„ÙˆÙ…Ø©: Ø­Ù„Ù‚Ø§Øª for ÙƒØ¨ÙŠØ±Ø© Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ±
      if (code.match(/for\s*\(.*\)\s*\{[^}]*\}/) && !code.match(/delay\(/)) issues.push({type:'info', msg:'Ø­Ù„Ù‚Ø© ÙƒØ¨ÙŠØ±Ø© Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ±Ø› Ù‚Ø¯ ØªØ¹Ù…Ù„ Ø¨Ø³Ø±Ø¹Ø© Ø¹Ø§Ù„ÙŠØ©.'});
      return issues;
    }
    function renderLint(){
      const issues = lintCode(lessonEditor.value);
      const panel = $('#lintPanel'); panel.innerHTML = '';
      if (!issues.length){ panel.innerHTML = '<p>âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø±Ø¦ÙŠØ³ÙŠØ©.</p>'; return; }
      issues.forEach(i => {
        const d = document.createElement('div'); d.className = 'badge';
        const color = i.type==='warn' ? 'âš ï¸' : i.type==='info' ? 'â„¹ï¸' : 'âŒ';
        d.innerHTML = `${color} ${i.msg}`;
        panel.appendChild(d);
      });
    }
    lessonEditor.addEventListener('input', renderLint);

    // ========== Ø§Ù…ØªØ­Ø§Ù† Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª ==========
    function shuffle(arr){ return arr.map(a=>({a, r:Math.random()})).sort((x,y)=>x.r-y.r).map(x=>x.a); }
    function renderQuiz(bank){
      quizContainer.innerHTML = '';
      const pick = shuffle(bank).slice(0, Math.min(3, bank.length));
      let score = 0, answered = 0;
      pick.forEach((item, idx) => {
        const w = document.createElement('div');
        w.className = 'lesson-card';
        const choices = shuffle(item.choices.map((c,i)=>({c,i})));
        const buttons = choices.map(ch => `<button class="secondary" data-qi="${idx}" data-ci="${ch.i}">${ch.c}</button>`).join(' ');
        w.innerHTML = `<p><strong>Ø³Ø¤Ø§Ù„ ${idx+1}:</strong> ${item.q}</p><div class="btns">${buttons}</div>`;
        quizContainer.appendChild(w);
      });
      quizResult.style.display = 'none';
      quizContainer.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const qi = parseInt(btn.dataset.qi, 10);
          const ci = parseInt(btn.dataset.ci, 10);
          const ls = lessons.find(x => x.id === currentLessonId);
          const correct = pick[qi].answer;
          const cat = pick[qi].cat;
          if (ci === correct){ score++; btn.classList.add('success'); }
          else { btn.classList.add('danger'); }
          // disable all buttons of this question
          quizContainer.querySelectorAll(`button[data-qi="${qi}"]`).forEach(b => b.disabled = true);
          answered++;
          quizResult.style.display = 'block';
          quizResult.textContent = `Ø£Ø¬Ø¨Øª Ø¹Ù„Ù‰ ${answered} Ø³Ø¤Ø§Ù„(Ø§Ù‹) â€¢ Ù†ØªÙŠØ¬ØªÙƒ: ${score}/${answered}`;
          localStorage.setItem(`lesson-${currentLessonId}-quiz`, JSON.stringify({score, answered}));
          // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
          const analytics = JSON.parse(localStorage.getItem('quiz-analytics') || '{}');
          analytics[cat] = (analytics[cat]||0) + (ci===correct?1:0);
          localStorage.setItem('quiz-analytics', JSON.stringify(analytics));
          markLessonProgress(currentLessonId, 'quiz');
          renderProgressPanel();
        });
      });
    }

    // ========== Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ==========
    $('#saveNotesBtn').addEventListener('click', () => {
      if (!currentLessonId) return;
      try {
        localStorage.setItem(`lesson-${currentLessonId}-notes`, notesArea.value);
        notesSavedAlert.style.display = 'block';
        setTimeout(() => notesSavedAlert.style.display = 'none', 2000);
        logActivity(`Ø­ÙØ¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯Ø±Ø³ ${currentLessonId}`);
        markLessonProgress(currentLessonId, 'notes');
        renderProgressPanel();
      } catch {}
    });

    // ========== Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ø¨Ø§Ø¯Ø¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø·Ø· ==========
    function markLessonProgress(id, action){
      const k = `lesson-${id}-progress`;
      const p = JSON.parse(localStorage.getItem(k) || '{}');
      p[action] = true;
      localStorage.setItem(k, JSON.stringify(p));
    }
    function calcCompleted(){
      let completed = 0;
      lessons.forEach(ls => {
        const p = JSON.parse(localStorage.getItem(`lesson-${ls.id}-progress`) || '{}');
        if (p.run && p.quiz) completed++;
      });
      return completed;
    }
    function renderProgressPanel(){
      const completed = calcCompleted();
      $('#completedCount').textContent = completed.toString();
      const pct = Math.round((completed/lessons.length)*100);
      $('#progressBar').style.width = pct+'%';
      // Ø¨Ø§Ø¯Ø¬Ø§Øª
      const b = $('#badges'); b.innerHTML = '';
      if (pct>=10) b.innerHTML += `<div class="badge">ğŸ–ï¸ Ø¨Ø¯Ø§ÙŠØ© Ù‚ÙˆÙŠØ©</div>`;
      if (pct>=50) b.innerHTML += `<div class="badge">ğŸ… Ù†ØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚</div>`;
      if (pct>=100) b.innerHTML += `<div class="badge">ğŸ† Ø¥Ù†Ø¬Ø§Ø² ÙƒØ§Ù…Ù„</div>`;
      renderChart();
    }
    function renderChart(){
      const cvs = $('#progressChart'), ctx = cvs.getContext('2d');
      ctx.clearRect(0,0,cvs.width,cvs.height);
      const w = cvs.width, h = cvs.height;
      // Ø±Ø³Ù… Ø¨Ø³ÙŠØ·: Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ù„ÙƒÙ„ 5 Ø¯Ø±ÙˆØ³
      const bins = [0,0];
      lessons.forEach(ls => {
        const p = JSON.parse(localStorage.getItem(`lesson-${ls.id}-progress`) || '{}');
        const done = (p.run?1:0)+(p.quiz?1:0)+(p.notes?1:0);
        if (ls.id<=5) bins[0]+=done; else bins[1]+=done;
      });
      const max = Math.max(...bins,1);
      const barW = (w-60)/bins.length, base = h-30;
      bins.forEach((v,i)=>{
        const bh = Math.round((v/max)*(h-60));
        ctx.fillStyle = i===0 ? '#0aa2b8' : '#4caf50';
        ctx.fillRect(30 + i*barW, base - bh, barW - 20, bh);
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text');
        ctx.fillText(i===0?'Ø¯Ø±ÙˆØ³ 1-5':'Ø¯Ø±ÙˆØ³ 6-10', 30 + i*barW, base + 16);
        ctx.fillText(v.toString(), 30 + i*barW, base - bh - 6);
      });
    }
    window.addEventListener('resize', renderChart);

    // ========== Ø´Ù‡Ø§Ø¯Ø© PDF Ù…Ø¨Ø³Ø·Ø© ==========
    function generateCertificate(){
      const completed = calcCompleted();
      const pct = Math.round((completed/lessons.length)*100);
      if (pct < 70){ alert('ÙŠÙ„Ø²Ù… Ø¥ÙƒÙ…Ø§Ù„ 70% Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ù‡Ø§Ø¯Ø©.'); return; }
      const name = prompt('Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:') || 'Ù…ØªØ¹Ù„Ù… Ø§Ù„Ø£Ø±Ø¯ÙˆÙŠÙ†Ùˆ';
      // ØªÙˆÙ„ÙŠØ¯ PDF Ø¨Ø³ÙŠØ· Ø¹Ø¨Ø± Data URL (Ù†Øµ/ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Canvas Ø«Ù… Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©)
      const c = document.createElement('canvas'); c.width = 900; c.height = 600;
      const ctx = c.getContext('2d');
      ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,c.width,c.height);
      ctx.fillStyle = '#0aa2b8'; ctx.fillRect(0,0,c.width,80);
      ctx.fillStyle = '#08343f'; ctx.font = 'bold 36px system-ui';
      ctx.fillText('Ø´Ù‡Ø§Ø¯Ø© Ø¥ØªÙ…Ø§Ù… â€” ØªØ¹Ù„Ù… Ø§Ù„Ø£Ø±Ø¯ÙˆÙŠÙ†Ùˆ', 20, 50);
      ctx.fillStyle = '#333'; ctx.font = '24px system-ui';
      ctx.fillText(`ÙŠÙÙ…Ù†Ø­ ${name} Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ø¥ØªÙ…Ø§Ù…Ù‡ ${pct}% Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø©.`, 20, 160);
      ctx.font = '20px system-ui';
      ctx.fillText(`Ø±Ù‚Ù… ØªØ­Ù‚Ù‚: ARD-${Date.now()}`, 20, 220);
      const icon = generateIcon(128);
      const img = new Image(); img.onload = ()=>{
        ctx.drawImage(img, c.width-170, 130, 128, 128);
        const url = c.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url; a.download = `certificate-${name}.png`;
        a.click();
      }; img.src = icon;
    }
    $('#generateCert').addEventListener('click', generateCertificate);

    // ========== ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON ==========
    function exportProgress(){
      const data = {};
      lessons.forEach(ls => {
        data[`lesson-${ls.id}-code`] = localStorage.getItem(`lesson-${ls.id}-code`);
        data[`lesson-${ls.id}-notes`] = localStorage.getItem(`lesson-${ls.id}-notes`);
        data[`lesson-${ls.id}-quiz`] = localStorage.getItem(`lesson-${ls.id}-quiz`);
        data[`lesson-${ls.id}-progress`] = localStorage.getItem(`lesson-${ls.id}-progress`);
      });
      data['quiz-analytics'] = localStorage.getItem('quiz-analytics');
      data['activity-log'] = localStorage.getItem('activity-log');
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'arduino-progress.json'; a.click();
      URL.revokeObjectURL(url);
      logActivity('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø¯Ù…');
    }
    function importProgress(){
      const inp = document.createElement('input');
      inp.type = 'file'; inp.accept = 'application/json';
      inp.onchange = () => {
        const file = inp.files[0]; if (!file) return;
        const fr = new FileReader();
        fr.onload = () => {
          try {
            const data = JSON.parse(fr.result);
            Object.keys(data).forEach(k => {
              if (data[k] !== null && data[k] !== undefined) localStorage.setItem(k, data[k]);
            });
            alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
            logActivity('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù…');
            renderProgressPanel(); route();
          } catch(e){ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.'); }
        };
        fr.readAsText(file);
      };
      inp.click();
    }
    $('#exportBtn').addEventListener('click', exportProgress);
    $('#importBtn').addEventListener('click', importProgress);

    // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³) ==========
    $('#adminAdd').addEventListener('click', () => {
      const title = $('#adminTitle').value.trim();
      const video = $('#adminVideo').value.trim();
      const intro = $('#adminIntro').value.trim();
      const code  = $('#adminCode').value.trim();
      if (!title || !intro || !code){ alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.'); return; }
      const newId = (lessons[lessons.length-1]?.id || 0) + 1;
      lessons.push({
        id:newId, title, video, intro, defaultCode:code, tags:["custom"], quizBank:[
          { q:"Ø³Ø¤Ø§Ù„ ØªÙ…Ù‡ÙŠØ¯ÙŠØŸ", choices:["ØµØ­ÙŠØ­","Ø®Ø·Ø£"], answer:0, cat:"custom" }
        ]
      });
      $('#adminAlert').style.display = 'block'; setTimeout(()=>$('#adminAlert').style.display='none', 2000);
      renderHome();
      logActivity(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯: ${newId} â€” ${title}`);
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¹Ø¯Ø§Ø¯
      $('#totalCount').textContent = lessons.length.toString();
    });

    // ========== PWA: manifest Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù ==========
    const icon192 = generateIcon(192);
    const icon512 = generateIcon(512);
    const manifest = {
      name: "ØªØ¹Ù„Ù… Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø£Ø±Ø¯ÙˆÙŠÙ†Ùˆ",
      short_name: "Arduino Learn",
      lang: "ar", dir: "rtl",
      start_url: ".",
      scope: ".",
      display: "standalone",
      theme_color: "#0aa2b8",
      background_color: "#0f121a",
      icons: [
        { src: icon192, sizes: "192x192", type: "image/png", purpose: "any" },
        { src: icon512, sizes: "512x512", type: "image/png", purpose: "any maskable" }
      ]
    };
    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    const linkManifest = document.createElement('link');
    linkManifest.rel = 'manifest';
    linkManifest.href = manifestURL;
    document.head.appendChild(linkManifest);

    // ========== Service Worker Ù…ÙˆØ³Ù‘Ø¹ ==========
    const swCode = `
      const CACHE_NAME = 'arduino-learn-adv-v1';
      const APP_SHELL = ['./'];
      self.addEventListener('install', (event) => {
        event.waitUntil(
          caches.open(CACHE_NAME).then(cache => cache.addAll(APP_SHELL)).then(() => self.skipWaiting())
        );
      });
      self.addEventListener('activate', (event) => {
        event.waitUntil(
          caches.keys().then(keys => Promise.all(keys.map(k => k === CACHE_NAME ? null : caches.delete(k))))
        );
        self.clients.claim();
      });
      self.addEventListener('fetch', (event) => {
        const req = event.request;
        event.respondWith(
          caches.match(req).then(cached => {
            if (cached) return cached;
            return fetch(req).then(res => {
              const copy = res.clone();
              caches.open(CACHE_NAME).then(cache => {
                if (req.method === 'GET' && req.url.startsWith(self.location.origin)) {
                  cache.put(req, copy).catch(()=>{});
                }
              });
              return res;
            }).catch(() => {
              if (req.mode === 'navigate') {
                return new Response('<h1 style="font-family:sans-serif">Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„</h1><p>ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© ØªØµÙØ­ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.</p>', { headers: { 'Content-Type': 'text/html; charset=utf-8' } });
              }
            });
          })
        );
      });
    `;
    const swBlob = new Blob([swCode], { type: 'application/javascript' });
    const swURL = URL.createObjectURL(swBlob);
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(swURL).catch(()=>{});
    }

    // ========== Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª ==========
    let deferredPrompt = null;
    const banner = $('#installBanner');
    const installBtn = $('#installBtn');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      banner.style.display = 'flex';
    });
    installBtn?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      await deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      banner.style.display = 'none';
      deferredPrompt = null;
      logActivity('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
    });

    // ========== ØªØ­Ù…ÙŠÙ„ ÙƒØ³ÙˆÙ„ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ ==========
    const videoEl = $('#lessonVideo');
    const observer = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting){
          videoEl.preload = 'auto';
        }
      });
    });
    observer.observe(videoEl);

    // ========== ØªÙ‡ÙŠØ¦Ø© ==========
    function init(){
      $('#activityLog').textContent = (localStorage.getItem('activity-log') || '// Ø§Ù„Ø³Ø¬Ù„ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...');
      renderHome();
      renderProgressPanel();
      route();
      renderLint();
      renderHighlight();
    }
    init();
  </script>
</body>
</html>
